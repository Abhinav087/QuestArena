<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuestArena v2 — Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ffd300;
            --accent: #4a7cff;
            --danger: #ff3b3b;
            --warning: #ffaa00;
            --bg: #1a1a2e;
            --card-bg: #0d0d1a;
            --border: #555555;
            --border-light: #c7c7c7;
            --text: #e0e0e0;
            --muted: #888;
            --btn-blue: #3f63b8;
            --btn-blue-hover: #557ce0;
            --btn-blue-shadow: #22356a;
            --font-heading: 'Press Start 2P', monospace;
            --font-body: 'Press Start 2P', monospace;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: var(--bg);
            background-image:
                linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px);
            background-size: 4px 4px;
            color: var(--text); font-family: var(--font-body); padding: 20px;
            image-rendering: pixelated;
        }
        h1, h2, h3 { font-family: var(--font-heading); text-transform: uppercase; letter-spacing: 1.5px; color: var(--primary); text-shadow: 2px 2px 0 #000; }
        .login-overlay {
            position: fixed; inset: 0; display: flex; justify-content: center; align-items: center;
            background: var(--bg); z-index: 1000;
        }
        .login-overlay.hidden { display: none; }
        .login-box {
            width: 100%; max-width: 420px; padding: 32px; border-radius: 0;
            border: 4px solid var(--border-light); background: var(--card-bg);
            box-shadow:
                inset 0 0 0 2px var(--card-bg),
                inset 0 0 0 4px var(--border),
                0 0 0 2px var(--border),
                0 0 0 4px #000;
        }
        .login-box h2 { margin-bottom: 10px; color: var(--primary); font-size: 0.9rem; }
        .login-box p { margin-bottom: 16px; color: var(--muted); font-size: 0.6rem; line-height: 1.6; }
        .login-box input {
            width: 100%; margin-bottom: 10px; padding: 10px;
            border: 3px solid var(--border-light); border-radius: 0;
            background: #111122; color: #fff; font-family: var(--font-body); font-size: 0.65rem;
            box-shadow: inset 0 0 0 2px var(--border), inset 2px 2px 0 rgba(0,0,0,0.5);
        }
        .error { color: var(--danger); min-height: 20px; font-size: 0.6rem; margin-bottom: 8px; text-shadow: 1px 1px 0 #000; }
        .btn {
            background: var(--btn-blue); border: 3px solid var(--border-light); color: #f4f7ff;
            padding: 8px 12px; border-radius: 0; cursor: pointer; font-family: var(--font-heading);
            font-size: 0.6rem; text-transform: uppercase;
            box-shadow:
                inset -2px -2px 0 var(--btn-blue-shadow),
                inset 2px 2px 0 rgba(255,255,255,0.15),
                0 3px 0 var(--btn-blue-shadow),
                0 4px 0 #000;
        }
        .btn:hover { background: var(--btn-blue-hover); color: #fff; transform: translateY(-1px); }
        .btn:active { transform: translateY(2px); box-shadow: inset -2px -2px 0 var(--btn-blue-shadow), 0 1px 0 var(--btn-blue-shadow); }
        .btn-danger {
            background: #6b1a1a; border-color: #ff4444; color: #ff4444;
            box-shadow: inset -2px -2px 0 #3d0e0e, inset 2px 2px 0 rgba(255,255,255,0.1), 0 3px 0 #3d0e0e, 0 4px 0 #000;
        }
        .btn-danger:hover { background: #872222; color: #fff; }
        .btn-warning {
            background: #6b5a1a; border-color: var(--warning); color: var(--warning);
            box-shadow: inset -2px -2px 0 #3d330e, inset 2px 2px 0 rgba(255,255,255,0.1), 0 3px 0 #3d330e, 0 4px 0 #000;
        }
        .btn-warning:hover { background: #877022; color: #fff; }
        .dashboard { display: none; }
        .dashboard.visible { display: block; }
        .header {
            margin-bottom: 16px; border-bottom: 4px solid var(--border-light); padding-bottom: 10px;
            box-shadow: 0 2px 0 var(--border);
        }
        .header h1 { color: var(--primary); font-size: 1rem; }
        .row { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); margin-bottom: 16px; }
        .card {
            border: 3px solid var(--border-light); border-radius: 0;
            background: var(--card-bg); padding: 14px;
            box-shadow:
                inset 0 0 0 2px var(--card-bg),
                inset 0 0 0 3px var(--border),
                0 0 0 2px #000;
        }
        .card h3 { font-size: 0.65rem; margin-bottom: 10px; color: var(--primary); text-shadow: 1px 1px 0 #000; }
        .meta { display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--muted); font-size: 0.55rem; }
        .meta strong { color: var(--text); }
        .inline { display: flex; gap: 8px; flex-wrap: wrap; }
        input, select {
            width: 100%; padding: 8px; border-radius: 0; border: 3px solid var(--border-light);
            background: #111122; color: var(--text); font-family: var(--font-body); font-size: 0.55rem;
            box-shadow: inset 0 0 0 2px var(--border), inset 2px 2px 0 rgba(0,0,0,0.5);
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.55rem; font-family: var(--font-body); }
        th, td { padding: 8px; border-top: 2px solid var(--border); text-align: left; text-shadow: 1px 1px 0 #000; }
        th { color: var(--primary); font-size: 0.5rem; text-transform: uppercase; }
        tr { transition: transform 0.1s ease; }
        tr.rank-bump { transform: translateY(-2px); }
        .actions { display: flex; gap: 6px; flex-wrap: wrap; }
        .small { font-size: 0.55rem; color: var(--muted); text-shadow: 1px 1px 0 #000; }
        pre { white-space: pre-wrap; font-size: 0.55rem; color: var(--text); font-family: 'Courier New', monospace; text-shadow: 1px 1px 0 #000; }
        #analytics { font-size: 0.72rem; line-height: 1.65; }
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--card-bg); border-left: 2px solid var(--border); }
        ::-webkit-scrollbar-thumb { background: var(--border); border: 2px solid var(--card-bg); }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-light); }
    </style>
</head>
<body>
    <div class="login-overlay" id="login-overlay">
        <div class="login-box">
            <h2>Admin Login</h2>
            <p>Authenticate to manage the event session.</p>
            <input type="password" id="admin-password" placeholder="Password" onkeydown="if(event.key==='Enter') adminLogin()">
            <div class="error" id="login-error"></div>
            <button class="btn" onclick="adminLogin()">Authenticate</button>
        </div>
    </div>

    <div class="dashboard" id="dashboard">
        <div class="header">
            <h1>QuestArena v2 Admin</h1>
            <div class="small">Single active session architecture</div>
        </div>

        <div class="row">
            <div class="card">
                <h3>Session Status</h3>
                <div class="meta"><span>Name</span><strong id="session-name">-</strong></div>
                <div class="meta"><span>Status</span><strong id="session-status">waiting</strong></div>
                <div class="meta"><span>Time Remaining</span><strong id="timer">00:00</strong></div>
                <div class="meta"><span>Players Connected</span><strong id="session-player-count">0</strong></div>
                <div class="meta"><span>Leaderboard Frozen</span><strong id="freeze-state">No</strong></div>
            </div>

            <div class="card">
                <h3>Create Session</h3>
                <input id="new-session-name" placeholder="Session Name" value="Fest Round 1">
                <input id="new-session-duration" type="number" min="5" max="240" value="30" style="margin-top:8px;">
                <div class="inline" style="margin-top:10px;">
                    <button class="btn" onclick="createSession()">Create New Session</button>
                    <button class="btn btn-warning" onclick="fetchSessions()">Refresh History</button>
                </div>
            </div>

            <div class="card">
                <h3>Timer Controls</h3>
                <div class="inline">
                    <button class="btn" onclick="adminPost('/api/admin/session/start')">Start</button>
                    <button class="btn btn-warning" onclick="adminPost('/api/admin/session/pause')">Pause</button>
                    <button class="btn" onclick="adminPost('/api/admin/session/resume')">Resume</button>
                    <button class="btn btn-danger" onclick="adminPost('/api/admin/session/end')">Force End</button>
                </div>
                <div class="inline" style="margin-top:10px;">
                    <button class="btn" onclick="adjustTime('/api/admin/session/add_time', 5)">+5 Min</button>
                    <button class="btn btn-warning" onclick="adjustTime('/api/admin/session/subtract_time', 5)">-5 Min</button>
                    <button class="btn" onclick="toggleFreeze()">Toggle Freeze</button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="card">
                <h3>Live Players</h3>
                <div class="inline" style="margin-bottom:10px;">
                    <select id="player-sort-key" onchange="applyPlayerSort()">
                        <option value="score" selected>Sort: Score</option>
                        <option value="username">Sort: Name</option>
                        <option value="current_level">Sort: Level</option>
                        <option value="time_taken_seconds">Sort: Time Taken</option>
                    </select>
                    <select id="player-sort-dir" onchange="applyPlayerSort()">
                        <option value="desc" selected>Order: Desc</option>
                        <option value="asc">Order: Asc</option>
                    </select>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>User</th><th>Score</th><th>Lvl</th><th>Time Taken</th><th>IP</th><th>State</th><th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="players-body">
                        <tr><td colspan="8" class="small">No players yet.</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h3>Leaderboard</h3>
                <div class="inline" style="margin-bottom:10px;">
                    <select id="leaderboard-sort-key" onchange="applyLeaderboardSort()">
                        <option value="score" selected>Sort: Score</option>
                        <option value="username">Sort: Name</option>
                        <option value="current_level">Sort: Level</option>
                        <option value="time_taken_seconds">Sort: Time Taken</option>
                    </select>
                    <select id="leaderboard-sort-dir" onchange="applyLeaderboardSort()">
                        <option value="desc" selected>Order: Desc</option>
                        <option value="asc">Order: Asc</option>
                    </select>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>#</th><th>User</th><th>Score</th><th>Level</th><th>Time Taken</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <tr><td colspan="5" class="small">No rankings yet.</td></tr>
                    </tbody>
                </table>
                <div class="inline" style="margin-top:10px;">
                    <button class="btn" onclick="exportCurrentSession()">Export CSV</button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="card">
                <h3>Session History</h3>
                <table>
                    <thead><tr><th>ID</th><th>Name</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody id="sessions-body"></tbody>
                </table>
            </div>

            <div class="card">
                <h3>Analytics</h3>
                <pre id="analytics">Select or run a session to view analytics.</pre>
            </div>
        </div>
    </div>

    <script>
        const API = window.location.origin;
        let adminToken = null;
        let currentSessionId = null;
        let currentFrozen = false;
        let currentPlayers = [];
        let currentLeaderboard = [];
        let selectedAnalyticsSessionId = null;
        let playerSortKey = 'score';
        let playerSortDirection = 'desc';
        let leaderboardSortKey = 'score';
        let leaderboardSortDirection = 'desc';

        function authHeaders() {
            return {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${adminToken}`,
            };
        }

        function toTimer(seconds) {
            const v = Math.max(0, Number(seconds || 0));
            const m = Math.floor(v / 60);
            const s = v % 60;
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        function toClock(value) {
            if (!value) return '-';
            try {
                return new Date(value).toLocaleTimeString();
            } catch {
                return '-';
            }
        }

        function toDuration(seconds) {
            if (seconds === null || seconds === undefined) return '-';
            const total = Math.max(0, Number(seconds));
            const h = Math.floor(total / 3600);
            const m = Math.floor((total % 3600) / 60);
            const s = total % 60;
            if (h > 0) return `${h}h ${m}m ${s}s`;
            if (m > 0) return `${m}m ${s}s`;
            return `${s}s`;
        }

        async function adminLogin() {
            const pwd = document.getElementById('admin-password').value;
            const errEl = document.getElementById('login-error');
            errEl.textContent = '';
            if (!pwd.trim()) { errEl.textContent = 'Enter password'; return; }

            try {
                const res = await fetch(`${API}/api/admin_login`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pwd })
                });
                if (!res.ok) { errEl.textContent = 'Wrong password'; return; }
                const data = await res.json();
                adminToken = data.token;
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('dashboard').classList.add('visible');
                await refreshAll();
                connectSocket();
                setInterval(refreshAll, 3000);
            } catch (err) {
                errEl.textContent = 'Server not reachable';
            }
        }

        async function adminPost(url, payload = null) {
            const res = await fetch(`${API}${url}`, {
                method: 'POST', headers: authHeaders(), body: payload ? JSON.stringify(payload) : null
            });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                alert(err.detail || 'Operation failed');
                return null;
            }
            await refreshAll();
            return res.json().catch(() => ({}));
        }

        async function createSession() {
            const name = document.getElementById('new-session-name').value.trim();
            const duration = Number(document.getElementById('new-session-duration').value || 30);
            if (!name) { alert('Session name required'); return; }
            await adminPost('/api/admin/session/create', { name, duration_minutes: duration });
        }

        async function adjustTime(url, minutes) {
            await adminPost(url, { minutes });
        }

        async function toggleFreeze() {
            await adminPost('/api/admin/leaderboard/freeze', { frozen: !currentFrozen });
        }

        async function fetchStatus() {
            const res = await fetch(`${API}/api/game_status`);
            const data = await res.json();
            currentSessionId = data.session_id;
            document.getElementById('session-name').textContent = data.name || '-';
            document.getElementById('session-status').textContent = data.status || 'waiting';
            document.getElementById('timer').textContent = toTimer(data.remaining_seconds || 0);
            document.getElementById('session-player-count').textContent = Number(data.player_count || 0);
        }

        async function fetchLeaderboard() {
            const res = await fetch(`${API}/api/leaderboard`);
            const rows = await res.json();
            currentLeaderboard = Array.isArray(rows) ? rows : [];
            renderLeaderboard();
        }

        function sortLeaderboard(rows) {
            const direction = leaderboardSortDirection === 'asc' ? 1 : -1;
            return [...rows].sort((a, b) => {
                let va;
                let vb;

                if (leaderboardSortKey === 'username') {
                    va = String(a.username || '').toLowerCase();
                    vb = String(b.username || '').toLowerCase();
                } else {
                    va = Number(a[leaderboardSortKey] ?? 0);
                    vb = Number(b[leaderboardSortKey] ?? 0);
                }

                if (va < vb) return -1 * direction;
                if (va > vb) return 1 * direction;
                return 0;
            });
        }

        function renderLeaderboard() {
            const body = document.getElementById('leaderboard-body');
            if (!currentLeaderboard.length) {
                body.innerHTML = '<tr><td colspan="5" class="small">No rankings yet.</td></tr>';
                return;
            }

            const sorted = sortLeaderboard(currentLeaderboard);
            body.innerHTML = sorted.map((r, i) => `
                <tr class="rank-bump">
                    <td>${i + 1}</td>
                    <td>${escapeHtml(r.username)}</td>
                    <td>${r.score}</td>
                    <td>${r.current_level}</td>
                    <td>${toDuration(r.time_taken_seconds)}</td>
                </tr>
            `).join('');
        }

        async function fetchPlayers() {
            const res = await fetch(`${API}/api/admin/players/live`, { headers: authHeaders() });
            if (!res.ok) return;
            const players = await res.json();
            currentPlayers = Array.isArray(players) ? players : [];
            renderPlayers();
            document.getElementById('freeze-state').textContent = currentPlayers.length ? document.getElementById('freeze-state').textContent : 'No';
        }

        function sortPlayers(rows) {
            const direction = playerSortDirection === 'asc' ? 1 : -1;
            return [...rows].sort((a, b) => {
                let va;
                let vb;

                if (playerSortKey === 'username') {
                    va = String(a.username || '').toLowerCase();
                    vb = String(b.username || '').toLowerCase();
                } else {
                    va = Number(a[playerSortKey] ?? -1);
                    vb = Number(b[playerSortKey] ?? -1);
                }

                if (va < vb) return -1 * direction;
                if (va > vb) return 1 * direction;
                return 0;
            });
        }

        function renderPlayers() {
            const body = document.getElementById('players-body');
            if (!currentPlayers.length) {
                body.innerHTML = '<tr><td colspan="8" class="small">No players yet.</td></tr>';
                return;
            }

            const sorted = sortPlayers(currentPlayers);
            body.innerHTML = sorted.map((p) => `
                <tr>
                    <td>${escapeHtml(p.username)}</td>
                    <td>${p.score}</td>
                    <td>${p.current_level}</td>
                    <td>${toDuration(p.time_taken_seconds)}</td>
                    <td>${escapeHtml(p.ip_address || '-')} ${p.duplicate_ip ? '⚠' : ''}</td>
                    <td>${p.is_banned ? 'Banned' : (p.is_active ? 'Active' : 'Inactive')}</td>
                    <td>
                        <div class="actions">
                            <button class="btn btn-warning" onclick="moveLevel(${p.id})">Move</button>
                            <button class="btn" onclick="adjustScore(${p.id})">Score</button>
                            <button class="btn" onclick="postPlayerAction(${p.id}, 'reset')">Reset</button>
                            <button class="btn btn-warning" onclick="postPlayerAction(${p.id}, 'kick')">Kick</button>
                            <button class="btn btn-danger" onclick="postPlayerAction(${p.id}, 'ban')">Ban</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function applyPlayerSort() {
            const keyEl = document.getElementById('player-sort-key');
            const dirEl = document.getElementById('player-sort-dir');
            playerSortKey = keyEl?.value || 'score';
            playerSortDirection = dirEl?.value || 'desc';
            renderPlayers();
        }

        function applyLeaderboardSort() {
            const keyEl = document.getElementById('leaderboard-sort-key');
            const dirEl = document.getElementById('leaderboard-sort-dir');
            leaderboardSortKey = keyEl?.value || 'score';
            leaderboardSortDirection = dirEl?.value || 'desc';
            renderLeaderboard();
        }

        async function postPlayerAction(playerId, action) {
            await adminPost(`/api/admin/player/${playerId}/${action}`);
        }

        async function moveLevel(playerId) {
            const level = prompt('Move player to level:', '0');
            if (level === null) return;
            await adminPost(`/api/admin/player/${playerId}/move-level`, { level: Number(level) });
        }

        async function adjustScore(playerId) {
            const delta = prompt('Score delta (e.g. 10 or -5):', '10');
            if (delta === null) return;
            await adminPost(`/api/admin/player/${playerId}/adjust-score`, { delta: Number(delta) });
        }

        async function fetchSessions() {
            const res = await fetch(`${API}/api/admin/sessions`, { headers: authHeaders() });
            if (!res.ok) return;
            const sessions = await res.json();
            const body = document.getElementById('sessions-body');
            if (!sessions.length) {
                body.innerHTML = '<tr><td colspan="4" class="small">No sessions found.</td></tr>';
                return;
            }
            body.innerHTML = sessions.map((s) => `
                <tr>
                    <td>${s.id}</td>
                    <td>${escapeHtml(s.name)}</td>
                    <td>${s.status}</td>
                    <td>
                        <div class="actions">
                            <button class="btn" onclick="viewAnalytics(${s.id})">Analytics</button>
                            <button class="btn" onclick="exportBySession(${s.id})">Export</button>
                            ${s.status === 'ended' ? `<button class='btn btn-danger' onclick='deleteSession(${s.id})'>Delete</button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        async function deleteSession(id) {
            if (!confirm('Delete this ended session and all related data?')) return;
            const res = await fetch(`${API}/api/admin/sessions/${id}`, { method: 'DELETE', headers: authHeaders() });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                alert(err.detail || 'Delete failed');
            }
            await refreshAll();
        }

        async function viewAnalytics(sessionId) {
            selectedAnalyticsSessionId = sessionId;
            const res = await fetch(`${API}/api/admin/analytics/${sessionId}`, { headers: authHeaders() });
            if (!res.ok) return;
            const data = await res.json();
            const top = data.top_player;
            const rows = Array.isArray(data.leaderboard) ? data.leaderboard : [];

            const indexHeader = 'S.No';
            const nameHeader = 'Name';
            const scoreHeader = 'Score';
            const timeHeader = 'Time';

            const indexWidth = Math.max(indexHeader.length, String(rows.length || 1).length) + 2;
            const nameWidth = Math.max(
                nameHeader.length,
                ...rows.map((item) => String(item.username || '').length),
                10
            ) + 2;
            const scoreWidth = Math.max(
                scoreHeader.length,
                ...rows.map((item) => String(item.score ?? 0).length),
                6
            ) + 2;

            const lines = [
                `Session Name: ${data.session_name || '-'}`,
                `Total Participants: ${data.total_participants ?? 0}`,
            ];

            if (top) {
                lines.push(`Top Player: ${top.username}`);
                lines.push(`Top Score: ${top.score}`);
                lines.push(`Time Taken: ${toDuration(top.time_taken_seconds)}`);
            } else {
                lines.push('Top Player: -');
                lines.push('Top Score: -');
                lines.push('Time Taken: -');
            }

            lines.push('');
            lines.push('-----------------------------------');
            lines.push(
                `${indexHeader.padEnd(indexWidth)}${nameHeader.padEnd(nameWidth)}${scoreHeader.padEnd(scoreWidth)}${timeHeader}`
            );

            if (!rows.length) {
                lines.push('No players found.');
            } else {
                rows.forEach((item, idx) => {
                    lines.push(
                        `${String(idx + 1).padEnd(indexWidth)}${String(item.username || '-').padEnd(nameWidth)}${String(item.score ?? 0).padEnd(scoreWidth)}${toDuration(item.time_taken_seconds)}`
                    );
                });
            }

            document.getElementById('analytics').textContent = lines.join('\n');
        }

        function exportBySession(sessionId) {
            window.open(`${API}/api/admin/export/${sessionId}`, '_blank');
        }

        function exportCurrentSession() {
            if (!currentSessionId) {
                alert('No session to export');
                return;
            }
            exportBySession(currentSessionId);
        }

        async function refreshAll() {
            await fetchStatus();
            await fetchLeaderboard();
            await fetchPlayers();
            await fetchSessions();
            const analyticsSessionId = selectedAnalyticsSessionId || currentSessionId;
            if (analyticsSessionId) {
                await viewAnalytics(analyticsSessionId);
            }
        }

        function connectSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const ws = new WebSocket(`${protocol}://${window.location.host}/ws/live`);
            ws.onopen = () => ws.send('admin-subscribe');
            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    if (message.event === 'session_update') {
                        const payload = message.payload || {};
                        document.getElementById('session-status').textContent = payload.status || 'waiting';
                        document.getElementById('timer').textContent = toTimer(payload.remaining_seconds || 0);
                        fetchStatus();
                    }
                    if (message.event === 'leaderboard_update') {
                        currentFrozen = !!(message.payload && message.payload.frozen);
                        document.getElementById('freeze-state').textContent = currentFrozen ? 'Yes' : 'No';
                        fetchLeaderboard();
                    }
                } catch (err) {
                    console.error(err);
                }
            };
            ws.onclose = () => setTimeout(connectSocket, 2000);
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
    </script>
</body>
</html>
